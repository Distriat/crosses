name: Webone with localhost.run

on: workflow_dispatch

jobs:
  webone-public:
    runs-on: ubuntu-latest
    
    steps:
    - name: Download and setup Webone
      run: |
        wget https://github.com/atauenis/webone/releases/download/v0.12.0/webone_linux-x64.zip
        unzip webone_linux-x64.zip
        chmod +x webone
    
    - name: Start Webone
      run: |
        ./webone --port 8080 &
        sleep 3
        echo "Webone started on port 8080"
    
    - name: Create public tunnel with localhost.run
      run: |
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º SSH-–∫–ª–∏–µ–Ω—Ç
        sudo apt-get install -y ssh
        
        # –°–æ–∑–¥–∞–µ–º —Ç—É–Ω–Ω–µ–ª—å (—Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ reverse SSH)
        ssh -R 80:localhost:8080 nokey@localhost.run > tunnel.log 2>&1 &
        sleep 5
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π URL –∏–∑ –ª–æ–≥–æ–≤
        TUNNEL_URL=$(grep "tunneled" tunnel.log | awk '{print $NF}')
        echo "Public URL: $TUNNEL_URL"
        echo "PUBLIC_URL=$TUNNEL_URL" >> $GITHUB_ENV
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º URL
        echo "üåê –í–∞—à Webone –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: $TUNNEL_URL"
    
    - name: Keep alive
      run: |
        echo "–°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å 55 –º–∏–Ω—É—Ç..."
        sleep 3300
